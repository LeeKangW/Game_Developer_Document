경량 패턴
===
[게임 프로그래밍 패턴](https://www.hanbit.co.kr/store/books/look.php?p_code=B4342659595) 책으로 공부하면서 정리한 내용입니다.   
자세한 내용을 원한다면, 책을 구매해서 확인해주세요.
***
```
자욱한 안개가 걷히자 웅장하고 오래된 숲이 모습을 드러낸다. 
하늘 위로 솟아오른 수많은 노송이 푸르른 대성당을 만든다. 
잎은 스테인드글라스 창처럼 햇빛을 산란시켜 황금빛 기둥을 만든다.
거대한 나무 줄기 사이로 숲은 끝없이 이어진다.
```
판타지 게임에서 흔히 볼수 이러한 설정에 대한 장면은 **경량** 패턴으로 종종 구현한다.


## 1. 경량 패턴 예제
#### 예시
- 빽빽한 숲을 만들어야 한다.
- 빽빽한 숲을 이루는 수천 가지의 나무를 게임에서 일일히 구현하는 건 쉽지 않다.(비용이 많이 듦)
- 나무에 필요한 데이터는 아래와 같다
```
- 줄기, 가지, 잎의 형태를 나타내는 폴리곤 메시
- 나무 껍질과 잎사귀 텍스쳐
- 숲에서의 위치와 방향
- 각각의 나무가 다르게 보이도록 크기와 음영 같은 값을 조절할 수 있는 매개변수
```
- 각 나무마다 데이터가 많고, 메시와 텍스쳐는 크기도 크다. 그렇기에 이렇게 많은 객체로 이루어진 숲 전체는 1프레임에 GPU로 모두 전달하기엔 양이 너무 많다.

#### 검증된 해결법
- 핵심: 숲에 나무가 수천 그루가 넘게 있어도 **대부분 비슷해 보인다**는 점
- 그러므로, 모든 나무를 같은 메시와 텍스처로 표현할 수 있음. 즉, 나무 객체에 들어 있는 데이터 대부분이 인스턴스별로 다르지 않다는 것.

#### 해결 방법
1. 모든 나무가 **다 같이 사용하는 데이터를 뽑아내** 새로운 Class에 모은다.   
> 게임 내 같은 메시와 텍스처를 여러 번 메모리에 올릴 이유가 없기에 TreeModel 객체는 **하나만 존재**하면 된다.
```C++
class TreeModel
{
  private:
    Mesh mesh;
    Texture bark;
    Texture leaves;
}
```
2. 각 나무 **인스턴스**는 공유 객체인 TreeModel을 **참조**한다. Tree 클래스에는 인스턴스별로 다른 상태 값만 남긴다.
```C++
class Tree
{
  private:
    TreeModel* model;
    
    Vector position;
    double height;
    double thickness;
    Color barkTint;
    Color leafTint;
}
```

위 내용을 그림으로 표현하면 이런 느낌
![image](https://user-images.githubusercontent.com/48194683/126032298-d2727604-f6ba-4c26-9303-ef45e11b673e.png)

## 2. 메모리에 올렸으면 렌더링을 방법
- GPU로 보내는 데이터 양을 최소화하기 위해서 공유 데이터인 TreeModel을 딱 **한 번**만 보낼 수 있어야 한다.
- 이후, 나무마다 값이 다른 내용을 전달하고, 마지막으로 GPU에 **전체 나무 인스턴스를 그릴 때 공유 데이터를 사용해**라고 하면 된다
- 다행히, 요즘 나오는 그래픽 카드나 API에선 이런 기능을 제공하는데 Direct3D, OpenGL 모두 **인스턴스 렌더링(instanced rendering)** 을 지원한다.


## 3. 경량 패턴
- 어떤 객체의 수가 너무 많아서 좀 더 **가볍게 만들고 싶을 때** 사용한다.
- 인스턴스 렌더링에서는 메모리 크기 보다 렌더링할 나무 데이터를 하나씩 GPU 버스로 보내는데 걸리는 **시간**이 중요하지만, 기본 개념은 경량 패턴과 같다
- 열거형을 선언해 수많은 다중 선택문(switch)을 만들 생각이면, 경량 패턴을 먼저 고려해볼 수 있다.

경량 패턴은 객체 데이터를 두 종류로 나눈다.
1. 모든 객체의 데이터 값이 같아서 공유할 수 있는 데이터 모으기 (예제에서 TreeModel)
  > 이런 데이터를
  > GoF에선 **고유 상태(intrinsic state)** 라 한다.
2. 나머지 데이터는 인스턴스별로 값이 다른 **외부 상태(extrinsic state)** 에 해당 (예제에서 Tree)

- 공유 객체가 명확하지 않은 경우, 경량 패턴은 잘 드러나지 않는다.

## 4. 어디에 사용할 수 있을까??
- 각기 다른 인스턴스에서 같은 데이터가 있는 경우
  - 예시에 나온 숲과 나무
  - 바닥 시스템
    - 예를 들어, 풀, 강, 진흙이 있다
    - 각 땅마다 플레이어 속도 변화, 텍스쳐, 사운드 등 동일하게 들어가는 정보가 있다.
    - 동일하게 들어가는 정보를 하나에 묶어(예시의 TreeModel) 경량 패턴으로 사용할 수 있다.

